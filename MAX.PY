import telebot
import requests
import json
import os
import yt_dlp
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

MM = telebot.TeleBot('6303886527:AAG6pgUeXdJ8_-jNgVCXjrDeCMooLe-7eU8')
YOUR_ADMIN_ID = 6719309443   # Ø§ÙŠØ¯ÙŠÙƒ
USERS_FILE = "users.json"
CHANNELS_FILE = "channels.json"

CHANNELS = [
    {"name": "Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", "username": "YYQJQ"},
    {"name": "Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", "username": "YYQJQ"},
    {"name": "Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", "username": "YYQJQ"}
]

def load_users():
    if not os.path.exists(USERS_FILE):
        return {}
    with open(USERS_FILE, "r") as f:
        return json.load(f)

def save_users(users):
    with open(USERS_FILE, "w") as f:
        json.dump(users, f)

def load_channels():
    if not os.path.exists(CHANNELS_FILE):
        return CHANNELS
    with open(CHANNELS_FILE, "r") as f:
        return json.load(f)

def save_channels():
    with open(CHANNELS_FILE, "w") as f:
        json.dump(CHANNELS, f)

def check_subscriptions(user_id):
    for channel in CHANNELS:
        try:
            member_status = MM.get_chat_member(f"@{channel['username']}", user_id).status
            if member_status not in ["member", "administrator", "creator"]:
                return False
        except telebot.apihelper.ApiTelegramException as e:
            print(f"Error accessing channel @{channel['username']} for user {user_id}: {e}")
            return False
    return True

def download_video(url, output_folder="downloads"):
    try:
        if not os.path.exists(output_folder):
            os.makedirs(output_folder)
        ydl_opts = {
            'outtmpl': f'{output_folder}/%(title)s.%(ext)s',
            'format': 'best',
        }
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=True)
            return ydl.prepare_filename(info)
    except Exception as e:
        return str(e)

@MM.message_handler(commands=['start'])
def start_handler(mm):
    user_id = mm.from_user.id
    users = load_users()
    if str(user_id) not in users:
        users[str(user_id)] = {"first_name": mm.from_user.first_name, "username": mm.from_user.username}
        save_users(users)

    if not check_subscriptions(user_id):
        markup = InlineKeyboardMarkup()
        for channel in CHANNELS:
            markup.add(InlineKeyboardButton(f"Ø§Ø´ØªØ±Ùƒ ÙÙŠ {channel['name']} âœ…", url=f"https://t.me/{channel['username']}"))
        markup.add(InlineKeyboardButton("ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ âœ…", callback_data="check_subscription"))
        MM.send_message(mm.chat.id, "âŒ *Ø¹Ø°Ø±Ù‹Ø§ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª:*", parse_mode="Markdown", reply_markup=markup)
        return

    main_menu(mm)

def main_menu(mm):
    markup = InlineKeyboardMarkup(row_width=2)
    markup.add(
        InlineKeyboardButton("ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ", callback_data='download_videos'),
        InlineKeyboardButton("ğŸ“¢ Ù‚Ù†Ø§ØªÙ†Ø§", url='https://t.me/YYQJQ'),
        InlineKeyboardButton("ğŸ¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙˆØª", switch_inline_query="")
    )
    if mm.from_user.id == YOUR_ADMIN_ID:
        markup.add(
            InlineKeyboardButton("ğŸ‘¥ Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data='users_count'),
            InlineKeyboardButton("âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙˆØª", callback_data='admin_menu')
        )

    MM.send_message(
        mm.chat.id,
        f"ğŸ‰ *Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ Ø¹Ø²ÙŠØ²ÙŠ: ã€Š{mm.from_user.first_name}ã€‹ğŸ“.*\n\n"
        "- ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ù…Ù† Ù…ÙˆØ§Ù‚Ø¹ Ù…ØªØ¹Ø¯Ø¯Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ø®ØªÙ„ÙØ© ÙˆØ§Ù„Ø¥Ø³ØªÙ…Ø§Ø¹ Ø¥Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.\n\n"
        "- Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: (YoutubeØŒ InstagramØŒ FacebookØŒ TwitterØŒ TiktokØŒ SnapchatØŒ SoundcloudØŒ pinterestØŒ LikeeØŒ kwai).",
        parse_mode="Markdown",
        reply_markup=markup
    )

# Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±
@MM.callback_query_handler(func=lambda call: call.data == 'admin_menu')
def admin_menu(call):
    if call.from_user.id == YOUR_ADMIN_ID:
        markup = InlineKeyboardMarkup(row_width=1)
        markup.add(
            InlineKeyboardButton("ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data='broadcast_message'),
            InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ", callback_data='add_channel'),
            InlineKeyboardButton("ğŸ—‘ Ø­Ø°Ù Ù‚Ù†Ø§Ø© Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ", callback_data='remove_channel'),
            InlineKeyboardButton("âš™ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø£Ùˆ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª", callback_data='toggle_bot')
        )
        MM.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø°ÙŠ ØªØ±ØºØ¨ ÙÙŠÙ‡:", chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=markup)
    else:
        MM.answer_callback_query(call.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±!")

@MM.callback_query_handler(func=lambda call: call.data == 'broadcast_message')
def broadcast_message(call):
    if call.from_user.id == YOUR_ADMIN_ID:
        MM.send_message(call.message.chat.id, "Ù…Ù† ÙØ¶Ù„ÙƒØŒ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù†Ø´Ø±Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.")
        MM.register_next_step_handler(call.message, process_broadcast_message)
    else:
        MM.answer_callback_query(call.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±!")

def process_broadcast_message(mm):
    message_type = None
    if mm.content_type == 'text':
        message_type = 'text'
    elif mm.content_type == 'photo':
        message_type = 'photo'
    elif mm.content_type == 'sticker':
        message_type = 'sticker'
    
    if message_type == 'text':
        message_to_broadcast = mm.text
        users = load_users()
        for user_id in users.keys():
            try:
                MM.send_message(user_id, message_to_broadcast)
            except Exception as e:
                print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {e}")
    elif message_type == 'photo':
        photo = mm.photo[-1].file_id  # Ø£Ø®Ø° Ø£ÙØ¶Ù„ ØµÙˆØ±Ø©
        caption = mm.caption if mm.caption else ""
        users = load_users()
        for user_id in users.keys():
            try:
                MM.send_photo(user_id, photo, caption=caption)
            except Exception as e:
                print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {e}")
    elif message_type == 'sticker':
        sticker = mm.sticker.file_id
        users = load_users()
        for user_id in users.keys():
            try:
                MM.send_sticker(user_id, sticker)
            except Exception as e:
                print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„ØµÙ‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {e}")
    MM.send_message(mm.chat.id, "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.")

@MM.callback_query_handler(func=lambda call: call.data == 'add_channel')
def add_channel(call):
    if call.from_user.id == YOUR_ADMIN_ID:
        MM.send_message(call.message.chat.id, "Ù…Ù† ÙØ¶Ù„ÙƒØŒ Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø¯ÙˆÙ† @).")
        MM.register_next_step_handler(call.message, process_add_channel)
    else:
        MM.answer_callback_query(call.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±!")

def process_add_channel(mm):
    new_channel_username = mm.text
    if new_channel_username not in [channel['username'] for channel in CHANNELS]:
        CHANNELS.append({"name": f"Ø§Ù„Ù‚Ù†Ø§Ø© {len(CHANNELS)+1}", "username": new_channel_username})
        save_channels()  # Ø­ÙØ¸ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        MM.send_message(mm.chat.id, f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù†Ø§Ø© @{new_channel_username} Ø¨Ù†Ø¬Ø§Ø­.")
    else:
        MM.send_message(mm.chat.id, "Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.")

@MM.callback_query_handler(func=lambda call: call.data == 'remove_channel')
def remove_channel(call):
    if call.from_user.id == YOUR_ADMIN_ID:
        markup = InlineKeyboardMarkup()
        for channel in CHANNELS:
            markup.add(InlineKeyboardButton(f"Ø­Ø°Ù {channel['name']}", callback_data=f"remove_{channel['username']}"))
        MM.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ:", chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=markup)
    else:
        MM.answer_callback_query(call.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±!")

@MM.callback_query_handler(func=lambda call: call.data.startswith("remove_"))
def handle_remove_channel(call):
    if call.from_user.id == YOUR_ADMIN_ID:
        channel_to_remove = call.data.split('_')[1]
        global CHANNELS
        CHANNELS = [channel for channel in CHANNELS if channel['username'] != channel_to_remove]
        save_channels()
        MM.answer_callback_query(call.id, f"ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ù†Ø§Ø© @{channel_to_remove} Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ.")
        admin_menu(call.message)
    else:
        MM.answer_callback_query(call.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±!")

@MM.callback_query_handler(func=lambda call: call.data == 'toggle_bot')
def toggle_bot(call):
    if call.from_user.id == YOUR_ADMIN_ID:
        bot_status = 'Ù…ÙØ¹Ù„' if MM.is_polling else 'Ù…ØºÙ„Ù‚'
        if bot_status == 'Ù…ÙØ¹Ù„':
            MM.send_message(call.message.chat.id, "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª.")
            MM.stop_polling()
        else:
            MM.send_message(call.message.chat.id, "ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª.")
            MM.polling()
    else:
        MM.answer_callback_query(call.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±!")

@MM.callback_query_handler(func=lambda call: call.data == 'users_count')
def users_count_handler(call):
    if call.from_user.id == YOUR_ADMIN_ID:
        users = load_users()
        MM.answer_callback_query(call.id, f"ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {len(users)}")
    else:
        MM.answer_callback_query(call.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±!")

@MM.callback_query_handler(func=lambda call: call.data == "check_subscription")
def check_subscription_handler(call):
    if check_subscriptions(call.from_user.id):
        MM.answer_callback_query(call.id, "âœ… Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø´ØªØ±Ø§ÙƒÙƒ! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.")
        main_menu(call.message)
    else:
        MM.answer_callback_query(call.id, "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!")

MM.polling()
